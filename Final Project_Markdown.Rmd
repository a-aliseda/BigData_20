---
title: "Big Data: Final Project"
author: "Angel Aliseda, Javier Patino, Fernando Regalado, Felipe Salazar"
date: "5/12/2020"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = TRUE,
                      message = TRUE,
                      fig.align = "center")

library(tidyverse)
library(tidytext)
library(SnowballC)
library(tm)
library(topicmodels)
library(rtweet)
library(dplyr)
library(ggplot2)
library(readxl)
library(syuzhet)
library(tibble)
library(wordcloud)
library(gamlr)
library(maptpx)
library(knitr)


set.seed(411234)

theme_set(theme_minimal())
```

## Retrieving the tweets from the accounts of Donald Trump and Joe Biden

## Data transformation
```{r Data}
# Load database from repository
data <- read.csv(file = "Candidates_tweets.csv") %>%
  mutate(text = as.character(text))

var_list <- names(data)
#View(var_list)
dim(data)
```

```{r data one-word-per-row}
# Transformation -> one-word-per-row
data_tokens <- data %>% 
  # tokenizing text from tweets
  unnest_tokens(output = text,                       
                input = text) %>%
  # remove numbers and string to lowercase
  filter(!str_detect(text, "^[0-9]*$")) %>%
  mutate(text = str_to_lower(text)) %>%
  # removing stop words
  anti_join(stop_words, by = c("text" = "word")) %>%
  # stemming words to avoid redundancy
  mutate(word_stem = wordStem(text)) %>%
  # merging with SENTIMENT DICTIONARY
  inner_join(get_sentiments("bing"), by = c("text" = "word"))

dim(data_tokens)
```

```{r data one-tweet-per-row matrix}
# Transformation -> one-tweet-per-row matrix
(data_matrix <- data_tokens %>%
  # get count of each token in each document
  count(X, word_stem) %>%
  # creating a document-term matrix with all features and tf weighting
  cast_dtm(document = X, term = word_stem, value = n))
```
## Topic Modelling
```{r}
data_matrix_trump <- data_tokens %>%
  mutate(screen_name = as.character(screen_name)) %>%
  filter(screen_name == "realDonaldTrump",
         text != "trump") %>%
  count(X, text) %>%
  cast_dtm(document = X,
           term = text,
           value = n) %>%
  removeSparseTerms(sparse = .99)

data_matrix_biden <- data_tokens %>%
  mutate(screen_name = as.character(screen_name)) %>%
  filter(screen_name == "JoeBiden",
         text != "trump") %>%
  count(X, text) %>%
  cast_dtm(document = X,
           term = text,
           value = n) %>%
  removeSparseTerms(sparse = .99)

# remove documents with no terms remaining
(data_matrix_trump <- data_matrix_trump[unique(data_matrix_trump$i),])
(data_matrix_biden <- data_matrix_biden[unique(data_matrix_biden$i),])

# Assuming only 2 topics
trump_topics <- topics(data_matrix_trump,K=2, verb=10)
rownames(trump_topics$theta)[order(trump_topics$theta[,1], decreasing=TRUE)[1:5]]
rownames(trump_topics$theta)[order(trump_topics$theta[,2], decreasing=TRUE)[1:5]]

biden_topics <- topics(data_matrix_biden,K=2, verb=10)
rownames(biden_topics$theta)[order(biden_topics$theta[,1], decreasing=TRUE)[1:5]]
rownames(biden_topics$theta)[order(biden_topics$theta[,2], decreasing=TRUE)[1:5]]
```

### wordcloud
```{r}
# TRUMP
par(mfrow=c(1,2))
wordcloud(row.names(trump_topics$theta),
          freq=trump_topics$theta[,1],
          #min.freq=0.0001,
          col="maroon")
wordcloud(row.names(trump_topics$theta), 
          freq=trump_topics$theta[,2],
          #min.freq=0.0001,
          col="navy")

# BIDEN
par(mfrow=c(1,2))

wordcloud(row.names(biden_topics$theta),
          freq=biden_topics$theta[,1],
          #min.freq=0.0001,
          col="maroon")
wordcloud(row.names(biden_topics$theta), 
          freq=biden_topics$theta[,2],
          #min.freq=0.0001,
          col="navy")
```

### Topic regression
```{r}
## omega is the matrix of tweets topic weights
## we'll regress retweets_counts onto it
trump_fav <- slice(data, as.numeric(data_matrix_trump$dimnames$Docs))
y <- trump_fav[,"retweet_count"]

trumpreg <- gamlr(trump_topics$omega, y)

coef(trumpreg)*0.1 # number of retweets up or down for moving up 10\% weight in that topic

regtopics.cv <- cv.gamlr(trump_topics$omega, y,lambda.min.ratio=10^{-4})
regtopics.cv

## give it the word %s as inputs
#x <- 100*data_matrix_trump/rowSums(data_matrix_trump)

regwords.cv <- cv.gamlr(data_matrix_trump, y)

par(mfrow=c(1,2))

plot(regtopics.cv)
mtext("topic regression", font=2, line=2)

plot(regwords.cv)
mtext("bigram regression", font=2, line=2)

# min OOS MSE
min(regtopics.cv$cvm)
min(regwords.cv$cvm)
```

## Sentiment Analysis
```{r, warning=FALSE}
#Sentiment analysis for Trump
data_trump <- data[data$screen_name== "realDonaldTrump",]
data_trump$text_plain <- plain_tweets(data_trump$text)
sa_trump <- get_nrc_sentiment(data_trump$text_plain)
#Transposing the dataset
sa1_trump<-data.frame(t(sa_trump))
#Obtaining count
new_sa_trump <- data.frame(rowSums(sa1_trump))
names(new_sa_trump)[1] <- "count"
new_sa_trump <- cbind("sentiment" = rownames(new_sa_trump), new_sa_trump)
rownames(new_sa_trump) <- NULL


#Sentiment analysis for Biden
data_biden <- data[data$screen_name== "JoeBiden",]
data_biden$text_plain <- plain_tweets(data_biden$text)
sa_biden <- get_nrc_sentiment(data_biden$text_plain)
#Transposing the dataset
sa1_biden<-data.frame(t(sa_biden))
#Obtaining count
new_sa_biden <- data.frame(rowSums(sa1_biden))
names(new_sa_biden)[1] <- "count"
new_sa_biden <- cbind("sentiment" = rownames(new_sa_biden), new_sa_biden)
rownames(new_sa_biden) <- NULL

#Plotting the sentiments
qplot(sentiment, data=new_sa_trump[1:8,], weight=count, geom="bar",fill=sentiment)+ggtitle("Trump's Sentiments")
qplot(sentiment, data=new_sa_biden[1:8,], weight=count, geom="bar",fill=sentiment)+ggtitle("Biden's Sentiments")
qplot(sentiment, data=new_sa_trump[9:10,], weight=count, geom="bar",fill=sentiment)+ggtitle("Trump's Sentiments")
qplot(sentiment, data=new_sa_biden[9:10,], weight=count, geom="bar",fill=sentiment)+ggtitle("Biden's Sentiments")

```

## LASSO analysis for count of words on Favorites and Retweets

```{r fav_rt, warning=FALSE, results='asis'}

### Dependent variables for the LASSO analysis
## Favorites
# Total number of favorites for Trump for tweets included in term matrix
tweets <- as.numeric(data_matrix$dimnames$Docs)

favs_trump <- data %>% 
  select(X, favorite_count) %>% 
  filter(X<3215) %>% 
  filter(X %in% tweets & favorite_count>0) #original tweets included in the term matrix 

# Total number of favorites for Biden for tweets included in term matrix

favs_biden <- data %>% 
  select(X, favorite_count) %>% 
  filter(X>3214) %>% 
  filter(X %in% tweets & favorite_count>0) #original tweets included in the term matrix

## Retweets
# Trump 
rt_trump <- data %>% 
  select(X, retweet_count) %>% 
  filter(X<3215) %>% 
  filter(X %in% tweets) #retweets included in the term matrix

# Biden 
rt_biden <- data %>% 
  select(X, retweet_count) %>% 
  filter(X>3214) %>% 
  filter(X %in% tweets) #retweets included in the term matrix
```

What makes a successful tweet? Are there common words for candidates that gets them more favorites or retweets? In order to answer these questions, we performed a predictive analysis where we looked at whether there are common words that predict if a tweet is succesful. To do this, we used two variables that we obtained from the Twitter database which are total number of Favorites and total number of Retweets. 

We performed a LASSO analysis for both candidates and for Favorites and Retweets sepparately. Trump's tweets have a median of `r median(favs_trump$favorite_count)` favs and a median of `r median(rt_trump$retweet_count)` retweets. On the other hand, Biden's tweets have a median of `r median(favs_biden$favorite_count)` favs and `r median(rt_biden$retweet_count)` retweets. We can see here that, at least in Twitter, candidate Trump is more popular than candidate Biden which is reflection of the amount of time Trump invested in Twitter during his campaign and his presidency. 

The following plots show the LASSO analysis of the total number of favs and retweets by each word using the matrix we computed for the topic analysis. From the models with the lowest AICc, we obtained the top 10 words with the most positive and most negative effect for retweets and favs for each candidate.


``` {r lasso_all, warning=FALSE, results='asis'}
### LASSO for total count of Favorites as outcome variable for each candidate

lasso_favs_trump <- gamlr(data_matrix[favs_trump$X,], 
                          favs_trump$favorite_count)

lasso_favs_biden <- gamlr(data_matrix[as.character(favs_biden$X),],
                          favs_biden$favorite_count)

### LASSO for total count of Retweets as outcome variable for each candidate
lasso_rt_trump <- gamlr(data_matrix[rt_trump$X,], 
                          rt_trump$retweet_count)

lasso_rt_biden <- gamlr(data_matrix[as.character(rt_biden$X),],
                          rt_biden$retweet_count)

### LASSO plots for each model

plot(lasso_favs_trump,
     sub = "LASSO model for words on number of Favorites for Trump")

plot(lasso_favs_biden,
     sub = "LASSO model for words on number of Favorites for Biden")

plot(lasso_rt_trump,
     sub = "LASSO model for words on number of Retweets for Trump")

plot(lasso_rt_biden,
     sub = "LASSO model for words on number of Retweets for Biden")

### Top 5 words with highest effect on Favorites for both candidates
## Top 5 words with most positive effect on favs for Trump

lasso_favs_trump_coefs <- coef(lasso_favs_trump)[-1,]
kable(lasso_favs_trump_coefs[order(-lasso_favs_trump_coefs)][1:5],
      caption = "Trump's top 5 words with most positive effect on favorites")

## Top 5 words with most negative effect on favs for Trump
kable(lasso_favs_trump_coefs[order(lasso_favs_trump_coefs)][1:5],
      caption = "Trump's top 5 words with most negative effect on favorites")

## Top 5 words with most positive effect on favs for Biden
lasso_favs_biden_coefs <- coef(lasso_favs_biden)[-1,]
kable(lasso_favs_biden_coefs[order(-lasso_favs_biden_coefs)][1:5],
      caption = "Biden's top 5 words with most positive effect on favorites")

## Top 5 words with most negative effect on favs for Biden
kable(lasso_favs_biden_coefs[order(lasso_favs_biden_coefs)][1:5],
      caption = "Biden's top 5 words with most negative effect on favorites")

## Top 5 words with most positive effect on rt for Trump
lasso_rt_trump_coefs <- coef(lasso_rt_trump)[-1,]
kable(lasso_rt_trump_coefs[order(-lasso_rt_trump_coefs)][1:5],
      caption = "Trump's top 5 words with most positive effect on retweets")

## Top 5 words with most negative effect on rt for Trump
kable(lasso_rt_trump_coefs[order(lasso_rt_trump_coefs)][1:5],
      caption = "Trump's top 5 words with most negative effect on retweets")

## Top 5 words with most positive effect on rt for Biden
lasso_rt_biden_coefs <- coef(lasso_rt_biden)[-1,]
kable(lasso_rt_biden_coefs[order(-lasso_rt_biden_coefs)][1:5],
      caption = "Biden's top 5 words with most positive effect on retweets")

## Top 5 words with most negative effect on rt for Biden
kable(lasso_rt_biden_coefs[order(lasso_rt_biden_coefs)][1:5],
      caption = "Biden's top 5 words with most negative effect on retweets")


```

In the case of Trump's tweets, we can see that words such as 'obstacle', 'astoundishing', 'uncertain', or 'afraid' are the words with the most positive effects. The largest effect is the word 'bitter', because having that word in a tweet increased `r lasso_favs_trump_coefs[order(-lasso_favs_trump_coefs)][1]` the number of favorites a tweet receives. Moreover, the 10 words that have most negative effects in Trump's tweets are 'collusion', 'fast', 'strong', 'hater', 'approval'. This words relate to the Russia investigation but also they could relate to his continuous tweets about his allegedly high approval rate.
 
On the other hand, Biden's tweets have different words that have a positive effect on the number of favorites. For instance, words like 'incendiary', 'inept', 'unqualified', or 'incompetent' have strong positive effects. These words seem to be related to tweets talking about President Trump and his actions during the administration. Including one of this word in a tweet, is associated with an increase in the number of favorites by up to `r lasso_favs_biden_coefs[order(-lasso_favs_biden_coefs)][1]`. Further, words such as 'dictator' or 'agressive' have the most negative effect on the number of favorites for Biden. Which could signla that, even though Biden's followers like when he criticize President Trump, they do not fall for aggressive comments against him.

The last four tables present the words with the most positive and negative effects on the number of retweets. As we can see for Trump's tweets, the words are similar than the ones we found above. However, for negative effects, we found other words that relate to the impeachment process such as 'subpoena', 'crisis', or 'crime'. This reflects that, even among Trump followers, his tweets about the impeachment process and the Russia Investigation, harmed his popularity.

Moreover, for Biden's tweets a similar pattern arises. Words that describe President Trump as inept or unqualified gave him a wide support among his followers, but aggresive or harsher words against him lowered the popularity of his tweets.


## LASSO analysis for "successful" tweets
```{r lasso_success, warning=FALSE, results='asis'}

### We defined a "successful" tweet if it is on the 90th percentile or more 
success_fav_trump <- favs_trump$favorite_count>quantile(favs_trump$favorite_count,.9)
success_fav_biden <- favs_biden$favorite_count>quantile(favs_biden$favorite_count,.9)

## Analysis for Trump's successful tweets
lasso_favs_trump_success <- gamlr(data_matrix[favs_trump$X,], 
                                  success_fav_trump,
                                  family = "binomial")
plot(lasso_favs_trump_success,
     sub = "LASSO model for words on odds of being a successful tweet for Trump")

lasso_favs_trump_success_coefs <- coef(lasso_favs_trump_success)[-1,]
kable(lasso_favs_trump_success_coefs[order(-lasso_favs_trump_success_coefs)][1:10],
      caption = "Trump's top 10 words with highest effect on odds of being a successful tweet")

## Analysis for Bidens's successful tweets
lasso_favs_biden_success <- gamlr(data_matrix[as.character(favs_biden$X),], 
                                  success_fav_biden,
                                  family = "binomial")
plot(lasso_favs_biden_success,
     sub = "LASSO model for words on odds of being a successful tweet for Biden")

lasso_favs_biden_success_coefs <- coef(lasso_favs_biden_success)[-1,]
kable(lasso_favs_biden_success_coefs[order(-lasso_favs_biden_success_coefs)][1:10],
      caption = "Biden's top 10 words with highest effect on odds of being a successful tweet")

```


Test Felipe

## References

## Session info
```{r}
devtools::session_info()
```